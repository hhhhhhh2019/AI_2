<html>

	<head>
		<title>Smile Detect</title>
		<script src='AI.js'></script>
		<style>
			body {
				background-color: black;
			}

			canvas {
				background-color: white;
			}
		</style>
	</head>

	<body>
		<canvas width='300' height='300' id='cnv' onmousedown="on_mouse_down(event)" onmouseup="on_mouse_up(event)" onmousemove="on_mouse_move(event)"></canvas>
		<button onclick="happy()">happy</button>
		<button onclick="sad()">sad</button>
		<button onclick="tr()">train</button>
		<button onclick="r()">run</button>
		<script type="text/javascript">
			var cnv = document.getElementById('cnv');
			var ctx = cnv.getContext('2d');

			var w = 15;
			var h = 15;

			var cw = cnv.width / w;
			var ch = cnv.width / h;

			var is_mouse_down = false;

			var image = [];

			var cl = false;

			for (let i = 0; i < w * h; i++) {
				image.push(0);
			}

			function rast(x, y) {
				return [Math.round(x / cw), Math.round(y / ch)];
			}

			function on_mouse_down(e) {
				is_mouse_down = true;
				let pos = rast(e.pageX - cw, e.pageY - ch);

				cl = image[pos[1] * w + pos[0]];

				if (cl)
					image[pos[1] * w + pos[0]] = 0;
				else
					image[pos[1] * w + pos[0]] = 1;

				draw();
			}

			function on_mouse_up(e) {
				is_mouse_down = false;
			}

			function on_mouse_move(e) {
				if (is_mouse_down) {
					let pos = rast(e.pageX - cw, e.pageY - ch);
					if (cl)
						image[pos[1] * w + pos[0]] = 0;
					else
						image[pos[1] * w + pos[0]] = 1;
				}

				draw();
			}

			function draw() {
				ctx.clearRect(0, 0, cnv.width, cnv.height);

				for (let i = 0; i < h; i++) {
					for (let j = 0; j < w; j++) {
						if (image[i*w+j] == 1) {
							ctx.fillRect(j * cw, i * ch, cw, ch)
						}
					}
				}
			}


			let lays = [[], [[0,0],[0,0],[0,0],[0,0],[0,0]], [[0,0]]];
			for (let i = 0; i < w*h; i++) {
				lays[0].push([0,0]);
			}

			let weights = [[], [[Math.random(), Math.random(), Math.random(), Math.random(), Math.random(), Math.random()]]];
			for (let i = 0; i < 5; i++) {
				let a = [];
				for (let j = 0; j < w*h+1; j++) {
					a.push(Math.random());
				}
				weights[0].push(a);
			}

			let learning_data = [];

			function happy() {
				learning_data.push([image, [1]]);

				for (let i = 0; i < w * h; i++) {
					image[i] = 0;
				}

				draw();
			}

			function sad() {
				learning_data.push([image, [0]]);

				for (let i = 0; i < w * h; i++) {
					image[i] = 0;
				}

				draw();
			}

			function tr() {
				learn(lays, weights, learning_data, 10000, 1);
			}

			function r() {
				//alert(run(lays, weights, image)>0.5?'happy':'sad');
				alert(run(lays, weights, image));

				for (let i = 0; i < w * h; i++) {
					image[i] = 0;
				}

				draw();
			}
		</script>
	</body>

</html>